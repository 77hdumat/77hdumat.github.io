[{"id":0,"href":"/docs/server/nestjs/nestjs%EC%97%90%EC%84%9C-springboot-cache-%ED%9D%89%EB%82%B4%EB%82%B4%EA%B8%B0/","title":"NestJSì—ì„œ Spring Boot Cache í‰ë‚´ë‚´ê¸°","section":"NestJS","content":" Pain Point # ìµœê·¼ ì‚¬ë‚´ ì„œë¹„ìŠ¤ì— í° ê·œëª¨ì˜ ê³ ê°ì‚¬ê°€ ì´ì „í•˜ê²Œ ë˜ë©´ì„œ, ë¶€í•˜ ì•ˆì •ì„± ê°œì„ ì´ ìµœìš°ì„  ê³¼ì œë¡œ ë– ì˜¬ëìŠµë‹ˆë‹¤.\nì‚¬ë‚´ ëª¨ë“  ì„œë¹„ìŠ¤ëŠ” MSAë¡œ êµ¬ì„±ë˜ì–´ ìˆì—ˆê³ , ì €ëŠ” ì—¬ëŸ¬ ì„œë¹„ìŠ¤ë“¤ì„ íŒ”ë¡œì—…í•˜ëŠ” \u0026lsquo;BFF(Backend for Frontend)\u0026rsquo; ì„œë²„ë¥¼ ë‹´ë‹¹í•˜ê³  ìˆì—ˆê¸°ì— ë‹¤ì–‘í•œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ íŒ”ë¡œì—…í•˜ëŠ” ê³¼ì •ì—ì„œ ìƒê¸°ëŠ” ë³‘ëª©ì„ ê°œì„ í•´ì•¼ë§Œ í–ˆìŠµë‹ˆë‹¤. ìš°ì„  ê°€ì¥ ì ì€ ë¦¬ì†ŒìŠ¤ë¡œ í° íš¨ê³¼ë¥¼ ë‚¼ ìˆ˜ ìˆëŠ” ìºì‹œë¥¼ ë‹¤ì–‘í•œ ë©”ì„œë“œì— ì ìš©í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.\nê¸°ì¡´ ìºì‹œ ë¡œì§ì—ëŠ” ëª‡ ê°€ì§€ ë¬¸ì œì ì´ ìˆì—ˆìŠµë‹ˆë‹¤.\në¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ì˜¤ì—¼ ì¡°ê±´ë¶€ ìºì‹±ì˜ ì–´ë ¤ì›€ ì·¨ì•½í•œ ì—ëŸ¬ í•¸ë“¤ë§ ìºì‹œ ë¬´íš¨í™” ë¡œì§ì˜ ë¶„ì‚°ìœ¼ë¡œ ì¸í•œ ì¼ê´€ì„± ë¬¸ì œ ê³„ì¸µí˜• ìºì‹œ ë¯¸ì§€ì› ìœ„ì™€ ê°™ì€ ë¬¸ì œì ì„ í•´ê²°í•˜ì§€ ì•Šê³  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ê²Œ ë˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œê°€ íƒ„ìƒí•©ë‹ˆë‹¤. ğŸ˜¢\nasync getPaymentsKey(@Ctx() user: UserContext) { const storeId = user.storeId; const cacheKey = `get-clientKey-${storeId}`; let cacheValue = null; try { cacheValue = await this.cacheService.get(cacheKey); } catch (err) { this.logger.error(`ìºì‹œ ì¡°íšŒ ì‹¤íŒ¨: ${cacheKey}`, err.stack); cacheValue = null; } if (cacheValue) { return cacheValue; } const {clientKey, state} = await this.paymentsServcie.getPaymentsKey(storeId); try { if (state === \u0026#39;ACTIVE\u0026#39;) { await this.cacheService.set(cacheKey, {clientKey, state}); } } catch (err) { this.logger.error(`ìºì‹œ ì„¤ì • ì‹¤íŒ¨: ${cacheKey}`, err.stack); } return new GetPaymentsKeyResponse(clientKey, state); } ê¹”ë”í•œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ Spring Bootì˜ @Cacheable ì–´ë…¸í…Œì´ì…˜ê³¼ ê°™ì€ ì„ ì–¸ì  ìºì‹± ë°©ì‹ì„ NestJS í”„ë¡œì íŠ¸ì— ë„ì…í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.\nSpring Boot Cache ì°¸ê³ í•˜ê¸° # ë¬¸ì œ í•´ê²°ì— ì•ì„œ ì°¸ê³ í• ë§Œí•œ ìŠ¤í”„ë§ ë¶€íŠ¸ ìºì‹œì˜ ì˜µì…˜ì„ ëª‡ê°€ì§€ ì¶”ë ¤ë³´ê² ìŠµë‹ˆë‹¤.\n@Cacheable # Option Description cacheNames / value ìºì‹œë¥¼ ê·¸ë£¹í™”í•˜ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ key ìºì‹œ í•­ëª©ì„ ì‹ë³„í•˜ëŠ” ê³ ìœ  í‚¤ cacheManager ì—¬ëŸ¬ ìºì‹œ ì „ëµ(Redis, Memory) ì¤‘ í•˜ë‚˜ ì„ íƒ condition ë©”ì„œë“œ ì‹¤í–‰ ì „ ìºì‹œ ë¡œì§ì„ ì‹¤í–‰í• ì§€ ê²°ì •í•˜ëŠ” SpEL unless ë©”ì„œë“œ ì‹¤í–‰ í›„ ê²°ê³¼ê°’ì„ ìºì‹œì— ì €ì¥í• ì§€ ê²°ì •í•˜ëŠ” SpEL @CacheEvict # Option Description cacheNames / value ì‚­ì œí•  ìºì‹œê°€ ì†í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ key ì‚­ì œí•  íŠ¹ì • ìºì‹œ í•­ëª©ì˜ í‚¤ cacheManager ìºì‹œ ì‚­ì œë¥¼ ìˆ˜í–‰í•  ìºì‹œ ë§¤ë‹ˆì €ë¥¼ ì„ íƒ condition ë©”ì„œë“œ ì‹¤í–‰ ì „ ìºì‹œ ì‚­ì œ ë¡œì§ì„ ì‹¤í–‰í• ì§€ ê²°ì •í•˜ëŠ” í•¨ìˆ˜ allEntries trueì¼ ê²½ìš°, keyì™€ ë¬´ê´€í•˜ê²Œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ëª¨ë“  í•­ëª©ì„ ì‚­ì œ beforeInvocation trueì¼ ê²½ìš°, ë©”ì„œë“œ ì‹¤í–‰ ì „ì— ìºì‹œ ì‚­ì œ (ë©”ì„œë“œ ì„±ê³µ ì—¬ë¶€ì™€ ë¬´ê´€) ìºì‹œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ / ë©”ì„œë“œ ì‹¤í–‰ ì „, í›„ í‰ê°€ / ìºì‹œ ì „ëµ ì„ íƒ ë“± ë‹¤ì–‘í•œ ì˜µì…˜ë“¤ì„ ì¶”ë ¤ë³´ì•˜ìŠµë‹ˆë‹¤. BFF ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ê¸°ì— ë¶€ì¡±í•˜ì§€ ì•Šì€ ì˜µì…˜ë“¤ ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ êµ¬í˜„í•˜ê¸°ì— ì•ì„œ í•œê°€ì§€ í° ë¬¸ì œì— ì§ë©´í•©ë‹ˆë‹¤.\nNestJSì—ì„œ ì„ ì–¸ì  ìºì‹± ì‚¬ìš©í•˜ê¸° # NestJSëŠ” Spring Bootì˜ AOP(Aspect-Oriented Programming) ì¦‰, ë©”ì„œë“œ í˜¸ì¶œì„ ê°€ë¡œì±„ ë©”ì„œë“œ ì‹¤í–‰ ì „ í›„ë¡œ ì›í•˜ëŠ” ë¡œì§ì„ ì‹¤í–‰ ì‹œí‚¬ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ê³  ìˆì§€ ì•Šë‹¤ëŠ” ì ì…ë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ NestJSì—ì„œ ì„ ì–¸ì  ìºì‹œë¥¼ ìœ„í•œ ë°ì½”ë ˆì´í„°ë¥¼ ì–´ë–»ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆì„ê¹Œìš”? (ë¹„ìŠ·í•œ ê¸°ëŠ¥ìœ¼ë¡œ interceptorê°€ ìˆì§€ë§Œ ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œë§Œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì— ì í•©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)\nê°„ë‹¨í•œ í•´ê²°ì±…ìœ¼ë¡œ @toss/nestjs-aop ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. 1\ntoss/nestjs-aopì˜ í•µì‹¬ ì›ë¦¬ëŠ” NestJSì˜ í‘œì¤€ Interceptor ë°©ì‹ì´ ì•„ë‹Œ, ë¶€íŒ… ë¼ì´í”„ ì‚¬ì´í´ì„ í™œìš©í•´ DI ì»¨í…Œì´ë„ˆê°€ ì´ˆê¸°í™”ëœ í›„, AOPì˜ ëŒ€ìƒì´ ë˜ëŠ” ë©”ì„œë“œë¥¼ ì°¾ì•„ ëŸ°íƒ€ì„ì— ì§ì ‘ êµì²´(Monkey-Patching) í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŠ” ì„œë¹„ìŠ¤ ê°„ì˜ ë‚´ë¶€ ë©”ì„œë“œ í˜¸ì¶œì„ í¬í•¨í•œ ëª¨ë“  Providerì˜ ë©”ì„œë“œì— AOPë¥¼ ì ìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.\në‚´ë¶€ ë™ì‘ ì›ë¦¬ëŠ” í¬ê²Œ [ë§ˆí‚¹] â†’ [íƒìƒ‰] â†’ [êµì²´] â†’ [ì‹¤í–‰] 4ë‹¨ê³„ë¡œ ë‚˜ë‰©ë‹ˆë‹¤.\në§ˆí‚¹ # ê³ ìœ  Symbolê³¼ metadataë¥¼ ì¸ìë¡œ ë°›ì•„ ë©”ì„œë“œ ë°ì½”ë ˆì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. applyDecorators ë¥¼ í†µí•´ ë‘ ê°œì˜ ë°ì½”ë ˆì´í„° í•¨ìˆ˜ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì ìš©í•©ë‹ˆë‹¤. ì½”ë“œë¥¼ ì£¼ì„ìœ¼ë¡œ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\nexport const createDecorator = ( metadataKey: symbol | string, metadata?: unknown, ): MethodDecorator =\u0026gt; { const aopSymbol = Symbol(\u0026#39;AOP_DECORATOR\u0026#39;); return applyDecorators( // 1. ë©”íƒ€ë°ì´í„° ì €ì¥ (target: object, propertyKey: string | symbol, descriptor: PropertyDescriptor) =\u0026gt; { // Reflect APIë¥¼ í†µí•´ ë©”ì„œë“œì— ë¶€ì°©ë˜ë©° ì¶”í›„ Discovery ê³¼ì •ì—ì„œ ì‹ë³„ë©ë‹ˆë‹¤. return AddMetadata\u0026lt;symbol | string, AopMetadata\u0026gt;(metadataKey, { originalFn: descriptor.value, // ë°ì½”ë ˆì´í„°ê°€ ì ìš©ë˜ê¸° ì „ ì›ë³¸ ë©”ì„œë“œ metadata, // ì˜µì…˜ ì¸ì aopSymbol, // ê³ ìœ  ì‹¬ë³¼ })(target, propertyKey, descriptor); }, // 2. í”„ë¡ì‹œ ë©”ì„œë“œ ìƒì„± (_: object, propertyKey: string | symbol, descriptor: PropertyDescriptor) =\u0026gt; { const originalFn = descriptor.value; descriptor.value = function (this: any, ...args: unknown[]) { // AopModule.onModuleInit()ì—ì„œ ì„¤ì •ëœ wrap í•¨ìˆ˜ë¥¼ ì°¾ìŠµë‹ˆë‹¤. const wrappedFn = this[aopSymbol]?.[propertyKey]; if (wrappedFn) { // wrap í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. return wrappedFn.apply(this, args); } // Fallback - AopModuleì´ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš° ì›ë³¸ ë©”ì„œë“œ ì‹¤í–‰ return originalFn.apply(this, args); }; } ... íƒìƒ‰ # NestJS ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œì‘ë˜ê³  OnModuleInit ë¼ì´í”„ì‚¬ì´í´ í›…ì„ í†µí•´ ëª¨ë“  ì˜ì¡´ì„± ì£¼ì…ì´ ì™„ë£Œëœ ì´í›„ discoveryService ë¥¼ í†µí•´ ëª¨ë“  í”„ë¡œë°”ì´ë”ë¥¼ ìˆœíšŒí•©ë‹ˆë‹¤. ì´í›„ applyLazyDecoratorì—ì„œ metadataScanner ë¥¼ í†µí•´ ìœ„ì—ì„œ ë§ˆí‚¹í•´ë‘” AOP ë©”íƒ€ë°ì´í„°ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.\nexport class AutoAspectExecutor implements OnModuleInit { private readonly wrappedMethodCache = new WeakMap(); constructor( private readonly discoveryService: DiscoveryService, private readonly metadataScanner: MetadataScanner, private readonly reflector: Reflector, ) {} onModuleInit() { this.bootstrapLazyDecorators(); } private bootstrapLazyDecorators() { // ëª¨ë“  í”„ë¡œë°”ì´ë” ìˆœíšŒ const controllers = this.discoveryService.getControllers(); const providers = this.discoveryService.getProviders(); const lazyDecorators = this.lookupLazyDecorators(providers); if (lazyDecorators.length === 0) { return; } const instanceWrappers = providers .concat(controllers) .filter(({ instance }) =\u0026gt; instance \u0026amp;\u0026amp; Object.getPrototypeOf(instance)); for (const lazyDecorator of lazyDecorators) { for (const wrapper of instanceWrappers) { this.applyLazyDecorator(lazyDecorator, wrapper); } } } private applyLazyDecorator(lazyDecorator: LazyDecorator, instanceWrapper: InstanceWrapper\u0026lt;any\u0026gt;) { const target = instanceWrapper.isDependencyTreeStatic() ? instanceWrapper.instance : instanceWrapper.metatype?.prototype; if (!target) { console.debug(\u0026#39;[applyLazyDecorator] not found target\u0026#39;); return; } // ë§ˆí‚¹ ë‹¨ê³„ì—ì„œ ì ìš©í•´ë‘” AOP ë©”íƒ€ë°ì´í„° ì‹ë³„ const propertyKeys = this.metadataScanner.scanFromPrototype( target, instanceWrapper.isDependencyTreeStatic() ? Object.getPrototypeOf(target) : target, (name) =\u0026gt; name, ); ... êµì²´ # AOP ë©”íƒ€ë°ì´í„°ê°€ ë¶™ì€ ë©”ì„œë“œë¥¼ ë°œê²¬í•˜ë©´ AOP ë¡œì§ì„ ì‹¤ì œë¡œ ë‹´ê³  ìˆëŠ” LazyDecorator êµ¬í˜„ì²´ë¥¼ NestJSì˜ DI ì»¨í…Œì´ë„ˆì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤. (Aspectë„ Providerì´ë¯€ë¡œ ì˜ì¡´ì„± ì£¼ì…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.)\nconst metadataKey = this.reflector.get(ASPECT, lazyDecorator.constructor); // instanceì— method names ë¥¼ ìˆœíšŒí•˜ë©´ì„œ lazyDecorator.wrapì„ ì ìš©í•¨ for (const propertyKey of propertyKeys) { // the target method is must be object or function // @see: https://github.com/rbuckton/reflect-metadata/blob/9562d6395cc3901eaafaf8a6ed8bc327111853d5/Reflect.ts#L938 const targetProperty = target[propertyKey]; if (!targetProperty || (typeof targetProperty !== \u0026#34;object\u0026#34; \u0026amp;\u0026amp; typeof targetProperty !== \u0026#34;function\u0026#34;)) { continue; } const metadataList: AopMetadata[] = this.reflector.get\u0026lt;AopMetadata[]\u0026gt;( metadataKey, targetProperty, ); if (!metadataList) { continue; } for (const aopMetadata of metadataList) { this.wrapMethod({ lazyDecorator, aopMetadata, methodName: propertyKey, target }); } } ì´í›„ wrap ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê³ , wrap ë©”ì„œë“œì—ëŠ” ì›ë³¸ í•¨ìˆ˜(originalMethod) ì™€ AOP ë©”íƒ€ë°ì´í„°(options)ê°€ ì¸ìë¡œ ì „ë‹¬ë©ë‹ˆë‹¤. wrap ë©”ì„œë“œëŠ” ì´ ì›ë³¸ í•¨ìˆ˜ë¥¼ Closureë¡œ ì°¸ì¡°í•˜ëŠ” ìŠ¤í… í•¨ìˆ˜ë¡œ êµì²´í•©ë‹ˆë‹¤.\nprivate wrapMethod({ lazyDecorator, aopMetadata, methodName, target, }: { lazyDecorator: LazyDecorator; aopMetadata: AopMetadata; methodName: string; target: any; }) { const { originalFn, metadata, aopSymbol } = aopMetadata; const self = this; const wrappedFn = function (this: object, ...args: unknown[]) { const cache = self.wrappedMethodCache.get(this) || new WeakMap(); const cached = cache.get(originalFn); if (cached) { return cached.apply(this, args); } const wrappedMethod = lazyDecorator.wrap({ instance: this, methodName, method: originalFn.bind(this), metadata, }); cache.set(originalFn, wrappedMethod); self.wrappedMethodCache.set(this, cache); return wrappedMethod.apply(this, args); }; target[aopSymbol] ??= {}; target[aopSymbol][methodName] = wrappedFn; } ì‹¤í–‰ # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ ì–´ë”˜ê°€ì—ì„œ someService.someMethod() ë¥¼ ì‹¤í–‰í•˜ê³ , í•´ë‹¹ ë©”ì„œë“œì— AOP ë°ì½”ë ˆì´í„°ê°€ ë¶™ì–´ìˆì—ˆë‹¤ë©´ êµì²´ëœ ìŠ¤í… í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.\n// ë°˜í™˜ëœ ìŠ¤í… í•¨ìˆ˜ ì˜ˆì‹œ wrap({ method, metadata: options }) { return (...args: any[]) =\u0026gt; { console.log(\u0026#39;AOP: Before original method\u0026#39;); // (\u0026#39;before\u0026#39; ë¡œì§) // \u0026#39;ì›ë³¸ í•¨ìˆ˜\u0026#39;ê°€ \u0026#39;ìŠ¤í… í•¨ìˆ˜\u0026#39; ë‚´ë¶€ì— ë§¤í•‘ (Closure) const result = method(...args); console.log(\u0026#39;AOP: After original method\u0026#39;); // (\u0026#39;after\u0026#39; ë¡œì§) return result; }; } @toss/nestjs-aop\u0026#160;\u0026#x21a9;\u0026#xfe0e;\n"}]